# GitHub Actions CI/CD 工作流配置文件
# CI/CD 是什么? Continuous Integration/Continuous Deployment 持续集成/持续部署
# - 每次push或pr时,自动运行测试和代码检查
# - 确保代码质量,防止bug进入main分支
#
# GitHub Actions 是什么? GitHub官方提供的免费自动化平台
# - 在GitHub服务器上自动执行脚本
# - 无需本地运行,速度快,可靠性高
#
# 工作流说明:
# 1. 监听push和pull_request事件
# 2. 在ubuntu系统上执行任务(job)
# 3. 依次运行多个步骤(steps)
# 4. 如果任何步骤失败,整个工作流失败(红灯)

name: CI

# 触发条件: 什么时候运行这个工作流?
on:
  # 当有人push到main分支时运行
  push:
    branches:
      - main
  # 当有人提交pull request到main分支时运行
  pull_request:
    branches:
      - main

jobs:
  # job名称: 这个job做什么? 运行测试
  test:
    # 运行环境: 在哪个操作系统上运行?
    # ubuntu-latest 是Linux系统,免费,官方推荐
    runs-on: ubuntu-latest

    steps:
      # 步骤1: 检出代码
      # 作用: 将GitHub仓库的代码拉到runner(运行环境)中
      # 这样runner才能访问我们的项目文件
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2: 安装Python环境
      # 作用: 设置Python 3.10版本
      # python-version: '3.10' 指定具体版本号
      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 步骤3: 安装依赖包
      # 作用: 安装测试和代码检查所需的包
      # pytest: 用于运行测试的框架
      # ruff: 快速的Python代码检查工具,可以发现语法错误
      # aiohttp: 异步HTTP库,benchmark.py需要导入它
      # 注意: 我们不装torch/transformers/vllm等GPU包,因为:
      #   - 测试只检查纯Python逻辑(JSON解析,指标计算)
      #   - 不需要加载模型,不需要GPU
      #   - 这样速度快,成本低
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest ruff aiohttp

      # 步骤4: 运行代码检查(linting)
      # 作用: 检查代码质量,找出潜在问题
      # ruff check: 检查指定目录下的Python文件
      # eval/ scripts/ tests/: 检查这三个目录
      # --ignore E501: 忽略"行太长"的警告
      #   E501 = 代码行超过79字符
      #   我们允许长行,因为有时候一行代码更清楚
      - name: Run linting with ruff
        run: ruff check eval/ scripts/ tests/ --ignore E501

      # 步骤5: 运行单元测试
      # 作用: 执行tests/目录下的所有测试
      # pytest tests/ -v:
      #   tests/: 要运行的测试目录
      #   -v: verbose模式,显示每个测试的详细输出
      # 测试内容: test_metrics.py测试JSON解析,指标计算,奖励函数等纯Python逻辑
      - name: Run tests
        run: pytest tests/ -v
